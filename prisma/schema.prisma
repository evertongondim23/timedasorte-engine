// ===============================================
// üé≤ PRISMA SCHEMA - JOGO DA SORTE ENGINE
// ===============================================
// Schema para sistema de apostas e sorteios
// Baseado em: Jogo do Bicho com Times de Futebol
// ===============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===============================================
// üéØ ENUMS CENTRALIZADOS
// ===============================================

// ===============================================
// üë• USU√ÅRIOS
// ===============================================

enum Roles {
  USER         // Usu√°rio comum (apostador)
  ADMIN        // Administrador da plataforma
  SYSTEM_ADMIN // Super administrador
  OPERATOR     // Operador de sorteios
}

enum UserStatus {
  ACTIVE    // Ativo
  INACTIVE  // Inativo
  SUSPENDED // Suspenso
  BANNED    // Banido
}

enum KYCStatus {
  PENDING    // Aguardando documentos
  IN_REVIEW  // Em an√°lise
  APPROVED   // Aprovado
  REJECTED   // Rejeitado
}

// ===============================================
// üí∞ TRANSA√á√ïES FINANCEIRAS
// ===============================================

enum TransactionType {
  DEPOSIT    // Dep√≥sito
  WITHDRAWAL // Saque
  BET        // Aposta
  PRIZE      // Pr√™mio
  FEE        // Taxa
  REFUND     // Reembolso
  BONUS      // B√¥nus
}

enum TransactionStatus {
  PENDING    // Pendente
  PROCESSING // Processando
  COMPLETED  // Conclu√≠do
  FAILED     // Falhou
  CANCELLED  // Cancelado
}

enum PaymentMethod {
  PIX         // PIX
  CREDIT_CARD // Cart√£o de cr√©dito
  DEBIT_CARD  // Cart√£o de d√©bito
  BOLETO      // Boleto banc√°rio
  BALANCE     // Saldo interno
}

// ===============================================
// üé≤ APOSTAS E SORTEIOS
// ===============================================

enum BetModality {
  TIME    // Aposta em um time
  CAMISA  // Aposta em n√∫mero de camisa
  DUPLA   // Aposta em dois times
  TERNO   // Aposta em tr√™s camisas
  PASSE   // Aposta em v√°rios times
  CENTENA // √öltimos 2 n√∫meros
  MILHAR  // 4 n√∫meros exatos
}

enum BetStatus {
  PENDING   // Aguardando sorteio
  WON       // Vencedora
  LOST      // Perdedora
  CANCELLED // Cancelada
  EXPIRED   // Expirada
}

enum DrawStatus {
  SCHEDULED   // Agendado
  OPEN        // Aberto para apostas
  CLOSED      // Fechado para apostas (cutoff)
  IN_PROGRESS // Em andamento
  COMPLETED   // Conclu√≠do
  CANCELLED   // Cancelado
  FAILED      // Falhou
}

enum ResultSource {
  ADMIN    // Resultado inserido por administrador
  OFFICIAL // Resultado de fonte oficial/legal
  SYSTEM   // Resultado gerado pelo sistema
}

// ===============================================
// üìÅ ARQUIVOS
// ===============================================

enum FileType {
  PROFILE_IMAGE      // Imagem de perfil
  TEAM_LOGO          // Logo de time
  DOCUMENT           // Documento (KYC)
  PAYMENT_RECEIPT    // Comprovante de pagamento
  DRAW_CERTIFICATE   // Certificado de sorteio
  OTHER              // Outro
}

// ===============================================
// üè¢ EMPRESAS (OPCIONAL - MULTI-TENANCY)
// ===============================================

model Company {
  id           String  @id @default(cuid())
  name         String
  cnpj         String? @unique
  website      String?
  contactEmail String?
  contactPhone String?

  // Relacionamentos
  users         User[]
  notifications Notification[]

  // Auditoria
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([cnpj])
  @@index([deletedAt])
}

// ===============================================
// üë• USU√ÅRIOS
// ===============================================

model User {
  id             String     @id @default(cuid())
  name           String
  email          String     @unique
  password       String
  role           Roles      @default(USER)
  status         UserStatus @default(ACTIVE)
  profilePicture String?
  phone          String?
  cpf            String?    @unique
  birthDate      DateTime?
  address        String?
  city           String?
  state          String?
  zipCode        String?

  // KYC (Know Your Customer)
  kycStatus       KYCStatus? @default(PENDING)
  kycSubmittedAt  DateTime?
  kycApprovedAt   DateTime?
  kycRejectedAt   DateTime?
  kycRejectionReason String?

  // Multi-tenancy (opcional)
  company   Company? @relation(fields: [companyId], references: [id])
  companyId String?

  // Relacionamentos
  wallet            Wallet?
  bets              Bet[]
  transactions      Transaction[]
  notifications     NotificationRecipient[]
  files             File[]                  @relation("UserFiles")
  auditLogs         AuditLog[]

  // Auditoria
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([email])
  @@index([cpf])
  @@index([status])
  @@index([role])
  @@index([kycStatus])
  @@index([companyId])
  @@index([deletedAt])
}

// ===============================================
// üí∞ CARTEIRAS
// ===============================================

model Wallet {
  id             String @id @default(cuid())
  balance        Float  @default(0) // Saldo dispon√≠vel
  blockedBalance Float  @default(0) // Saldo bloqueado (apostas pendentes)
  totalDeposited Float  @default(0) // Total depositado (hist√≥rico)
  totalWithdrawn Float  @default(0) // Total sacado (hist√≥rico)
  totalWon       Float  @default(0) // Total ganho em pr√™mios
  totalLost      Float  @default(0) // Total perdido em apostas

  // Dono da carteira
  user   User   @relation(fields: [userId], references: [id])
  userId String @unique

  // Auditoria
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([userId])
  @@index([deletedAt])
}

// ===============================================
// üí≥ TRANSA√á√ïES FINANCEIRAS
// ===============================================

model Transaction {
  id          String            @id @default(cuid())
  type        TransactionType
  amount      Float
  status      TransactionStatus @default(PENDING)
  method      PaymentMethod?
  description String?
  
  // Dados de pagamento externo
  externalId       String? // ID da transa√ß√£o no gateway
  externalStatus   String? // Status no gateway
  gatewayResponse  Json?   // Resposta completa do gateway
  
  // Comprovantes
  receiptUrl String?
  
  // Dono da transa√ß√£o
  user   User   @relation(fields: [userId], references: [id])
  userId String

  // Relacionamentos
  bet   Bet?    @relation(fields: [betId], references: [id])
  betId String?

  // Auditoria
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?
  deletedAt   DateTime?

  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([externalId])
  @@index([createdAt])
  @@index([deletedAt])
}

// ===============================================
// üèÜ TIMES
// ===============================================

model Team {
  id       Int     @id @default(autoincrement())
  name     String  @unique
  jerseys  Int[] // Array de n√∫meros de camisa [1,2,3,4]
  shield   String? // Emoji ou URL do escudo
  color    String // Cor hexadecimal
  animal   String // Nome do animal
  animalEmoji String // Emoji do animal
  isActive Boolean @default(true)

  // Relacionamentos
  bets BetTeam[]

  // Auditoria
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([isActive])
  @@index([deletedAt])
}

// ===============================================
// üé≤ APOSTAS
// ===============================================

model Bet {
  id       String      @id @default(cuid())
  modality BetModality
  amount   Float
  status   BetStatus   @default(PENDING)
  jerseys  Int[] // N√∫meros de camisa apostados
  
  // Resultado
  prize         Float?
  multiplier    Float?    @default(18) // Multiplicador de pr√™mio
  isWinner      Boolean   @default(false)
  winningReason String? // Explica√ß√£o do resultado
  
  // Apostador
  user   User   @relation(fields: [userId], references: [id])
  userId String

  // Times apostados (rela√ß√£o N:N)
  teams BetTeam[]

  // Sorteio relacionado
  draw   Draw?   @relation(fields: [drawId], references: [id])
  drawId String?

  // Liquida√ß√£o (settlement)
  settlement Settlement?

  // Transa√ß√µes relacionadas
  transactions Transaction[]

  // Auditoria
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  processedAt DateTime? // Quando foi processada
  deletedAt   DateTime?

  @@index([userId])
  @@index([drawId])
  @@index([status])
  @@index([modality])
  @@index([createdAt])
  @@index([deletedAt])
}

// ===============================================
// üîó RELA√á√ÉO N:N - APOSTAS E TIMES
// ===============================================

model BetTeam {
  id     String @id @default(cuid())
  bet    Bet    @relation(fields: [betId], references: [id], onDelete: Cascade)
  betId  String
  team   Team   @relation(fields: [teamId], references: [id])
  teamId Int

  createdAt DateTime @default(now())

  @@unique([betId, teamId])
  @@index([betId])
  @@index([teamId])
}

// ===============================================
// üé∞ SORTEIOS
// ===============================================

model Draw {
  id          String       @id @default(cuid())
  scheduledAt DateTime     // Data/hora agendada para publica√ß√£o do resultado
  cutoffAt    DateTime     // Data/hora limite para apostas (scheduledAt - 30min)
  publishedAt DateTime?    // Data/hora de publica√ß√£o do resultado
  executedAt  DateTime?    // Data/hora de execu√ß√£o do sorteio
  status      DrawStatus   @default(SCHEDULED)
  source      ResultSource @default(ADMIN) // Fonte do resultado
  externalRef String?      // Refer√™ncia externa (ex: ID da loteria oficial)
  
  // Resultados do sorteio
  milhares Int[] // 5 n√∫meros de 4 d√≠gitos [1234, 5678, ...]
  jerseys  Int[] // 5 n√∫meros de camisa (dezenas) [12, 35, 47, ...]
  teams    Int[] // 5 IDs de times sorteados [3, 9, 12, ...]
  
  // Auditoria e seguran√ßa
  seed               String? // Seed usado para RNG
  certificateHash    String? // Hash do certificado (blockchain)
  certificateUrl     String? // URL do certificado
  totalBets          Int     @default(0)
  totalPrizePool     Float   @default(0)
  totalWinners       Int     @default(0)
  totalPrizesPaid    Float   @default(0)
  
  // Operador respons√°vel
  operatorId String?
  
  // Relacionamentos
  bets        Bet[]
  settlements Settlement[]

  // Auditoria
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([scheduledAt])
  @@index([cutoffAt])
  @@index([status])
  @@index([source])
  @@index([executedAt])
  @@index([deletedAt])
}

// ===============================================
// üìä LIQUIDA√á√ïES E C√ÅLCULOS
// ===============================================

model Settlement {
  id           String   @id @default(cuid())
  betId        String   @unique
  bet          Bet      @relation(fields: [betId], references: [id], onDelete: Cascade)
  drawId       String
  draw         Draw     @relation(fields: [drawId], references: [id])
  
  // Snapshot do resultado para auditoria
  resultSnapshot Json    // { milhares, jerseys, teams, calculationDetails }
  
  // Dados de c√°lculo
  isWinner       Boolean
  matchedItems   String[] // Itens que bateram (times, dezenas, etc)
  prizeAmount    Float    @default(0)
  multiplier     Float    @default(0)
  
  // Auditoria
  computedAt DateTime @default(now())
  computedBy String?  // ID do sistema/operador que calculou
  
  @@index([drawId])
  @@index([computedAt])
}

// ===============================================
// üìÅ ARMAZENAMENTO DE ARQUIVOS
// ===============================================

model File {
  id           String   @id @default(cuid())
  originalName String
  fileName     String   @unique
  type         FileType
  size         Int
  mimeType     String
  url          String   @unique
  description  String?

  // Usu√°rio que fez upload
  uploadedByUser User?   @relation("UserFiles", fields: [uploadedBy], references: [id])
  uploadedBy     String?

  // Auditoria
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([uploadedBy])
  @@index([type])
  @@index([fileName])
  @@index([createdAt])
  @@index([deletedAt])
}

// ===============================================
// üîî SISTEMA DE NOTIFICA√á√ïES
// ===============================================

model Notification {
  id         String  @id @default(cuid())
  title      String
  message    String  @db.Text
  entityType String? // 'bet', 'draw', 'transaction', 'withdrawal'
  entityId   String? // ID da entidade relacionada

  // Multi-tenancy (opcional)
  company   Company? @relation(fields: [companyId], references: [id])
  companyId String?

  // Usu√°rio que criou a a√ß√£o (opcional)
  createdByUserId String?

  // Destinat√°rios da notifica√ß√£o
  recipients NotificationRecipient[]

  // Auditoria
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([companyId])
  @@index([entityType])
  @@index([entityId])
  @@index([createdAt])
  @@index([deletedAt])
}

model NotificationRecipient {
  id     String    @id @default(cuid())
  isRead Boolean   @default(false)
  readAt DateTime?

  // Notifica√ß√£o
  notification   Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  notificationId String

  // Usu√°rio destinat√°rio
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  // Auditoria
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([notificationId, userId])
  @@index([userId])
  @@index([notificationId])
  @@index([isRead])
}

// ===============================================
// üìã LOGS DE AUDITORIA
// ===============================================

model AuditLog {
  id         String @id @default(cuid())
  action     String // 'CREATE', 'UPDATE', 'DELETE', 'LOGIN', etc
  entity     String // 'User', 'Bet', 'Draw', 'Transaction'
  entityId   String?
  changes    Json? // Mudan√ßas realizadas
  ip         String?
  userAgent  String?
  
  // Usu√°rio que realizou a a√ß√£o
  user   User?   @relation(fields: [userId], references: [id])
  userId String?

  // Auditoria
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([entity])
  @@index([entityId])
  @@index([action])
  @@index([createdAt])
}
